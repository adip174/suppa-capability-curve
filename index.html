<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Capability Curve</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* AI Markdown minimal styling */
        .ai-content strong { color: #818cf8; }
        .ai-content p { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col items-center">

    <div class="max-w-7xl w-full">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-white tracking-wide">Generator Capability Curve</h1>
            <p class="text-slate-400 mt-2">PT. PLN Nusantara Power Services - PLTD SUPPA</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Panel: Inputs & Results -->
            <div class="glass-panel p-6 flex flex-col gap-6 lg:col-span-1 max-h-[850px] overflow-y-auto">
                
                <!-- Generator Specs (Grid Layout) -->
                <div>
                    <h2 class="text-lg font-semibold text-slate-200 border-b border-slate-700 pb-2 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Spesifikasi Teknis
                    </h2>
                    
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 mb-3 text-center">
                        <span class="text-xs text-slate-400 block mb-1">Model Generator</span>
                        <span class="font-bold text-white text-sm">ABB AMG 1250RR10 DSE</span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 text-center">
                            <span class="text-xs text-slate-400 block mb-1">Daya Semu (S)</span>
                            <span class="font-bold text-blue-400">14.33 MVA</span>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 text-center">
                            <span class="text-xs text-slate-400 block mb-1">Tegangan</span>
                            <span class="font-bold text-white">11.000 V</span>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 text-center">
                            <span class="text-xs text-slate-400 block mb-1">Frekuensi</span>
                            <span class="font-bold text-white">50 Hz</span>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 text-center">
                            <span class="text-xs text-slate-400 block mb-1">Putaran</span>
                            <span class="font-bold text-white">600 RPM</span>
                        </div>
                    </div>
                </div>

                <!-- Load Input Form (Now includes PF) -->
                <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30">
                    <h2 class="text-md font-semibold text-blue-300 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Simulasi Operasi
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">Power Factor (PF)</label>
                            <input type="number" id="inputPF" value="0.8" step="0.05" min="0.1" max="1" 
                                class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" 
                                oninput="onPFChange()">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">Beban Aktif (MW)</label>
                            <input type="number" id="inputMW" value="10.0" step="0.1" 
                                class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" 
                                oninput="calculateLimits()">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-slate-400 mb-1">Sifat Beban (Mode Operasi)</label>
                        <select id="inputMode" class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" onchange="calculateLimits()">
                            <option value="lagging">Lagging (Over-excited / Induktif)</option>
                            <option value="leading">Leading (Under-excited / Kapasitif)</option>
                        </select>
                    </div>

                    <button onclick="calculateLimits()" class="w-full bg-blue-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-blue-500 transition shadow-lg shadow-blue-500/30">Update Kalkulasi</button>
                    
                    <div class="mt-3 grid grid-cols-2 gap-2">
                        <div class="flex flex-col justify-center bg-blue-950/50 p-2 rounded border border-blue-800/50">
                            <span class="text-[10px] text-slate-400">Batas Maks Engine (P):</span>
                            <span class="text-sm font-bold text-blue-300" id="engineLimitText">11.46 MW</span>
                        </div>
                        <div class="flex flex-col justify-center bg-indigo-950/50 p-2 rounded border border-indigo-800/50">
                            <span class="text-[10px] text-slate-400">Reaktif Aktual (Q):</span>
                            <span class="text-sm font-bold text-indigo-300" id="actualMvarText">7.50 MVAR</span>
                        </div>
                    </div>
                </div>

                <!-- Results Display -->
                <div>
                    <h2 class="text-lg font-semibold text-slate-200 border-b border-slate-700 pb-2 mb-4">Batas Reaktif Teoritis</h2>
                    
                    <div id="alertBox" class="hidden mb-4 p-3 rounded-lg text-sm font-medium"></div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-emerald-900/20 p-4 rounded-lg border border-emerald-500/30 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
                            <p class="text-[10px] uppercase tracking-wider text-emerald-400 font-semibold mb-1">Maks Lagging</p>
                            <p class="text-[10px] text-slate-500 mb-2">(Over-excited)</p>
                            <p class="text-2xl font-bold text-emerald-400" id="resLagging">0.00</p>
                            <p class="text-[10px] text-emerald-500/70 mt-1 mb-2">MVAR</p>
                            <div class="bg-emerald-950/60 rounded py-1 px-2 border border-emerald-800/50 inline-block">
                                <p class="text-[10px] text-emerald-300">Batas Cos &phi;: <span id="resPFLagging" class="font-bold">0.000</span></p>
                            </div>
                        </div>
                        <div class="bg-amber-900/20 p-4 rounded-lg border border-amber-500/30 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-amber-500"></div>
                            <p class="text-[10px] uppercase tracking-wider text-amber-400 font-semibold mb-1">Maks Leading</p>
                            <p class="text-[10px] text-slate-500 mb-2">(Under-excited)</p>
                            <p class="text-2xl font-bold text-amber-400" id="resLeading">0.00</p>
                            <p class="text-[10px] text-amber-500/70 mt-1 mb-2">MVAR</p>
                            <div class="bg-amber-950/60 rounded py-1 px-2 border border-amber-800/50 inline-block">
                                <p class="text-[10px] text-amber-300">Batas Cos &phi;: <span id="resPFLeading" class="font-bold">0.000</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ✨ Gemini API Integration Section -->
                <div class="bg-indigo-900/20 p-4 rounded-lg border border-indigo-500/30 flex flex-col mt-2">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-md font-semibold text-indigo-300">Asisten Ahli AI</h2>
                        <button onclick="analyzeWithGemini()" id="btnAI" class="bg-indigo-600 text-white font-medium px-3 py-1.5 rounded-md hover:bg-indigo-500 transition shadow-lg shadow-indigo-500/30 text-xs flex items-center gap-1">
                            ✨ <span>Analisis AI</span>
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-400 mb-3 leading-relaxed">Dapatkan evaluasi margin keamanan berdasarkan kondisi simulasi.</p>
                    
                    <div id="aiLoading" class="hidden text-sm text-indigo-400 animate-pulse bg-indigo-950/50 p-3 rounded text-center border border-indigo-800/50">
                        Menghitung Margin Keamanan...
                    </div>
                    <div id="aiResultBox" class="hidden bg-slate-900/80 p-4 rounded border border-slate-700 max-h-72 overflow-y-auto">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-emerald-950/50 p-2 rounded border border-emerald-500/30 text-center">
                                <p class="text-[10px] text-emerald-400 font-semibold uppercase tracking-wider">AI Limit Lagging</p>
                                <p class="text-lg font-bold text-emerald-300" id="aiRecLagging">-</p>
                            </div>
                            <div class="bg-amber-950/50 p-2 rounded border border-amber-500/30 text-center">
                                <p class="text-[10px] text-amber-400 font-semibold uppercase tracking-wider">AI Limit Leading</p>
                                <p class="text-lg font-bold text-amber-300" id="aiRecLeading">-</p>
                            </div>
                        </div>
                        <div id="aiTextResult" class="text-sm text-slate-300 ai-content space-y-3"></div>
                    </div>
                </div>

            </div>

            <!-- Right Panel: Chart -->
            <div class="glass-panel p-6 lg:col-span-2 flex flex-col h-[650px] lg:h-auto">
                <h2 class="text-lg font-semibold text-slate-200 mb-4 text-center">Kurva Kapabilitas Generator</h2>
                <div class="flex-grow relative w-full h-full min-h-[400px]">
                    <canvas id="capabilityChart"></canvas>
                </div>
                <div class="text-[10px] text-slate-500 mt-4 text-center bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                    *Kurva didasarkan pada perhitungan limitasi Stator (MVA) dan aproksimasi stabilitas statis. Area di dalam kurva adalah area operasi aman. Garis putus-putus biru menunjukkan rentang operasi reaktif pada beban aktif saat ini.
                </div>
            </div>

        </div>
    </div>

    <script>
        let capabilityChart = null;
        
        // Fixed Parameters based on User Document
        const FIXED_MVA = 14.33;

        // Gemini API Configuration
        const apiKey = "AIzaSyDZnSGbyxnCJfCNqAPGb9igVEvOYZTO5Bc"; // Disuplai otomatis oleh environment eksekusi

        // Inisialisasi awal
        window.onload = function() {
            initChart();
            onPFChange();
        };

        function onPFChange() {
            let pf = parseFloat(document.getElementById('inputPF').value) || 0.8;
            if (pf > 1) pf = 1;
            if (pf <= 0) pf = 0.1; 
            
            const maxMW = FIXED_MVA * pf;
            document.getElementById('engineLimitText').innerText = `${maxMW.toFixed(2)} MW`;
            
            if (capabilityChart) {
                updateAll();
            }
        }

        function getParams() {
            const mwLoad = parseFloat(document.getElementById('inputMW').value) || 0;
            let pf = parseFloat(document.getElementById('inputPF').value) || 0.8;
            if (pf > 1) pf = 1;
            if (pf <= 0) pf = 0.1;
            const mode = document.getElementById('inputMode').value; // lagging or leading
            const maxMW = FIXED_MVA * pf;
            
            // Kalkulasi Q Aktual berdasarkan S = P / PF dan Q = sqrt(S^2 - P^2)
            const sActual = mwLoad / pf;
            let qActual = Math.sqrt(Math.max(0, Math.pow(sActual, 2) - Math.pow(mwLoad, 2)));
            
            // Jika mode leading, Q aktual menjadi negatif di grafik
            if (mode === 'leading') {
                qActual = -qActual;
            }

            return { mva: FIXED_MVA, pf, mwLoad, maxMW, qActual, mode };
        }

        // Fungsi batas
        function getLaggingLimit(p, s) {
            if (p > s) return 0;
            return Math.sqrt(Math.pow(s, 2) - Math.pow(p, 2));
        }

        function getLeadingLimit(p, s, pMax) {
            if (p > pMax) return 0;
            const maxLeadingAtZero = s * 0.35; 
            return -(maxLeadingAtZero * (1 - Math.pow((p / pMax), 2)));
        }

        function generateCurveData() {
            const { mva, maxMW } = getParams();
            const lagData = [];
            const leadData = [];
            const step = maxMW / 50; 

            for (let p = 0; p <= maxMW + step; p += step) {
                let currentP = p > maxMW ? maxMW : p;
                lagData.push({ x: currentP, y: getLaggingLimit(currentP, mva) });
                leadData.push({ x: currentP, y: getLeadingLimit(currentP, mva, maxMW) });
            }

            lagData.push({ x: maxMW, y: 0 });
            leadData.push({ x: maxMW, y: 0 });

            return { lagData, leadData };
        }

        function initChart() {
            const ctx = document.getElementById('capabilityChart').getContext('2d');
            
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.font.family = "'Inter', sans-serif";

            capabilityChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Batas Lagging (Stator Heating)',
                            data: [],
                            borderColor: '#34d399', 
                            backgroundColor: 'rgba(52, 211, 153, 0.15)',
                            showLine: true,
                            fill: '+1', 
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'Batas Leading (Stability Limit)',
                            data: [],
                            borderColor: '#fbbf24', 
                            backgroundColor: 'rgba(251, 191, 36, 0.15)',
                            showLine: true,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'Rentang Operasi Reaktif (Batas MW Saat Ini)',
                            data: [],
                            backgroundColor: 'rgba(96, 165, 250, 0)', 
                            borderColor: 'rgba(96, 165, 250, 0.4)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            showLine: true,
                            type: 'scatter'
                        },
                        {
                            label: 'Titik Operasi Aktual (P, Q)',
                            data: [],
                            backgroundColor: '#ef4444', // Red 500
                            borderColor: '#fca5a5',
                            borderWidth: 2,
                            pointRadius: 7,
                            pointHoverRadius: 10,
                            showLine: false,
                            type: 'scatter'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    return `P: ${context.parsed.x.toFixed(2)} MW, Q: ${context.parsed.y.toFixed(2)} MVAR`;
                                }
                            }
                        },
                        legend: { 
                            position: 'bottom',
                            labels: {
                                color: '#cbd5e1',
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Daya Aktif - P (MW)', color: '#cbd5e1', font: { weight: '600', size: 13 } },
                            min: 0,
                            grid: { color: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255,255,255,0.2)' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            title: { display: true, text: 'Daya Reaktif - Q (MVAR)', color: '#cbd5e1', font: { weight: '600', size: 13 } },
                            grid: { color: 'rgba(255, 255, 255, 0.05)', zeroLineColor: 'rgba(255, 255, 255, 0.3)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateAll() {
            const { lagData, leadData } = generateCurveData();
            
            capabilityChart.data.datasets[0].data = lagData;
            capabilityChart.data.datasets[1].data = leadData;
            
            const mva = FIXED_MVA;
            capabilityChart.options.scales.x.max = Math.ceil(mva);
            capabilityChart.options.scales.y.max = Math.ceil(mva);
            capabilityChart.options.scales.y.min = -Math.ceil(mva / 2);
            
            capabilityChart.update();
            calculateLimits();
        }

        function calculateLimits() {
            const { mva, maxMW, mwLoad, qActual, mode } = getParams();
            const alertBox = document.getElementById('alertBox');
            
            // Update teks aktual Q
            document.getElementById('actualMvarText').innerText = `${Math.abs(qActual).toFixed(2)} MVAR (${mode === 'lagging' ? 'Lagging' : 'Leading'})`;

            if (mwLoad < 0) {
                showAlert('Beban tidak boleh bernilai negatif.', 'red');
                setResults(0, 0, 0, 0);
                updateOperatingPoint(null, null);
                return;
            }

            const maxLagging = getLaggingLimit(mwLoad, mva);
            const maxLeading = getLeadingLimit(mwLoad, mva, maxMW);

            // Kalkulasi Batas Cos Phi (Power Factor) Teoritis
            let pfLaggingLimit = 0;
            let pfLeadingLimit = 0;
            if (mwLoad > 0) {
                pfLaggingLimit = mwLoad / Math.sqrt(Math.pow(mwLoad, 2) + Math.pow(maxLagging, 2));
                pfLeadingLimit = mwLoad / Math.sqrt(Math.pow(mwLoad, 2) + Math.pow(maxLeading, 2));
            }

            setResults(maxLagging, Math.abs(maxLeading), pfLaggingLimit, pfLeadingLimit); 
            
            // Garis vertikal putus-putus untuk rentang MW saat ini (Dataset 2)
            const rangeLineData = [
                { x: mwLoad, y: maxLagging },
                { x: mwLoad, y: maxLeading }
            ];

            // Titik merah untuk operasi aktual (Dataset 3)
            const actualPointData = [{ x: mwLoad, y: qActual }];

            // Sesuaikan skala grafik dinamis jika titik aktual melebihi batas tampilan awal
            let currentMaxX = Math.ceil(mva);
            let currentMaxY = Math.ceil(mva);
            let currentMinY = -Math.ceil(mva / 2);

            if (mwLoad > currentMaxX) currentMaxX = Math.ceil(mwLoad + 2);
            if (qActual > currentMaxY) currentMaxY = Math.ceil(qActual + 2);
            if (qActual < currentMinY) currentMinY = Math.floor(qActual - 2);

            capabilityChart.options.scales.x.max = currentMaxX;
            capabilityChart.options.scales.y.max = currentMaxY;
            capabilityChart.options.scales.y.min = currentMinY;

            updateOperatingPoint(rangeLineData, actualPointData);

            // Cek peringatan secara bertingkat
            if (mwLoad > maxMW) {
                showAlert(`Overload! Beban aktif (${mwLoad.toFixed(2)} MW) melebihi batas maksimal Engine (${maxMW.toFixed(2)} MW).`, 'red');
            } else if (qActual > maxLagging && mode === 'lagging') {
                showAlert(`Peringatan: Reaktif aktual (${qActual.toFixed(2)} MVAR) melebihi batas Lagging (${maxLagging.toFixed(2)} MVAR). Risiko Stator Overheat!`, 'red');
            } else if (qActual < maxLeading && mode === 'leading') {
                showAlert(`Peringatan: Reaktif aktual (${Math.abs(qActual).toFixed(2)} MVAR) melebihi batas Leading (${Math.abs(maxLeading).toFixed(2)} MVAR). Risiko Loss of Synchronism!`, 'red');
            } else {
                hideAlert();
            }
        }

        function setResults(lag, lead, pfLag, pfLead) {
            document.getElementById('resLagging').innerText = lag.toFixed(2);
            document.getElementById('resLeading').innerText = lead.toFixed(2); 
            document.getElementById('resPFLagging').innerText = pfLag.toFixed(3);
            document.getElementById('resPFLeading').innerText = pfLead.toFixed(3);
            // Reset AI box if parameters change
            document.getElementById('aiResultBox').classList.add('hidden');
        }

        function updateOperatingPoint(rangeData, pointData) {
            if(rangeData && pointData) {
                capabilityChart.data.datasets[2].data = rangeData;
                capabilityChart.data.datasets[3].data = pointData;
            } else {
                capabilityChart.data.datasets[2].data = [];
                capabilityChart.data.datasets[3].data = [];
            }
            capabilityChart.update();
        }

        function showAlert(msg, color) {
            const alertBox = document.getElementById('alertBox');
            const bgClasses = color === 'red' ? 'bg-red-900/30 border-red-500/50 text-red-400' : 'bg-blue-900/30 border-blue-500/50 text-blue-400';
            
            alertBox.className = `mb-4 p-3 rounded-lg text-sm font-medium border ${bgClasses}`;
            alertBox.innerText = msg;
            alertBox.classList.remove('hidden');
        }

        function hideAlert() {
            document.getElementById('alertBox').classList.add('hidden');
        }

        // --- GEMINI API INTEGRATION ---
        
        async function fetchWithRetry(url, payload, retries = 5) {
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        async function analyzeWithGemini() {
            const mwLoad = document.getElementById('inputMW').value;
            const resLagging = document.getElementById('resLagging').innerText;
            const resLeading = document.getElementById('resLeading').innerText;
            const mva = FIXED_MVA;
            const pf = document.getElementById('inputPF').value;

            const btnAI = document.getElementById('btnAI');
            const aiLoading = document.getElementById('aiLoading');
            const aiResultBox = document.getElementById('aiResultBox');
            const aiTextResult = document.getElementById('aiTextResult');

            // UI State: Loading
            btnAI.disabled = true;
            btnAI.classList.add('opacity-50', 'cursor-not-allowed');
            aiResultBox.classList.add('hidden');
            aiLoading.classList.remove('hidden');

            const systemPrompt = `Anda adalah asisten AI (Ahli Elektrikal Generator Sinkron). Anda mengevaluasi titik operasi generator berdasarkan teori *Capability Curve* yang mencakup batas Stator Heating, Rotor Heating (Field Limit), dan Under-excitation (Stability Limit).
Tugas Anda:
1. Berikan analisis teknis mengenai letak titik operasi beban aktif (MW) saat ini di dalam Capability Curve.
2. Tetapkan nilai rekomendasi batas operasional AMAN (Lagging dan Leading). Biasanya praktisi memberikan margin keamanan 5% hingga 15% lebih rendah dari batas teoritis absolut yang ada di kurva agar generator tidak overheat atau kehilangan sinkronisasi.
3. Berikan saran monitoring fisik untuk operator (misal: suhu belitan, vibrasi).
Gunakan bahasa Indonesia yang profesional.`;
            
            const userQuery = `Data operasi generator ABB AMG 1250RR10 DSE:
- Kapasitas: ${mva} MVA
- Power Factor: ${pf}
- Beban Aktif Saat Ini: ${mwLoad} MW
- Batas Teoritis Kurva Maks Lagging: ${resLagging} MVAR
- Batas Teoritis Kurva Maks Leading: ${resLeading} MVAR

Hasilkan evaluasi dalam format JSON berdasarkan Capability Curve.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { 
                    temperature: 0.2,
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            analisisKurva: { type: "STRING" },
                            rekomendasiOperator: { type: "STRING" },
                            batasLaggingAman: { type: "NUMBER" },
                            batasLeadingAman: { type: "NUMBER" }
                        },
                        required: ["analisisKurva", "rekomendasiOperator", "batasLaggingAman", "batasLeadingAman"]
                    }
                }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const result = await fetchWithRetry(url, payload);
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!responseText) throw new Error("Format respons tidak valid.");
                
                const aiData = JSON.parse(responseText);

                // Update UI Element
                document.getElementById('aiRecLagging').innerText = aiData.batasLaggingAman.toFixed(2) + " MVAR";
                document.getElementById('aiRecLeading').innerText = aiData.batasLeadingAman.toFixed(2) + " MVAR";

                aiTextResult.innerHTML = `
                    <div class="mb-2">
                        <strong class="text-indigo-300 block mb-1">Analisis Capability Curve:</strong>
                        <p class="leading-relaxed text-slate-300">${aiData.analisisKurva}</p>
                    </div>
                    <div>
                        <strong class="text-indigo-300 block mb-1">Rekomendasi Operasional:</strong>
                        <p class="leading-relaxed text-slate-300">${aiData.rekomendasiOperator}</p>
                    </div>
                `;
                aiResultBox.classList.remove('hidden');
            } catch (error) {
                aiTextResult.innerHTML = `<span class="text-red-400">Gagal terhubung ke AI atau memproses data kurva. Coba lagi beberapa saat.</span>`;
                aiResultBox.classList.remove('hidden');
            } finally {
                // UI State: Restore
                aiLoading.classList.add('hidden');
                btnAI.disabled = false;
                btnAI.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

    </script>
</body>
</html>